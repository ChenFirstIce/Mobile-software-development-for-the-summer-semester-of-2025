<!--pages/route/route.wxml-->
<view class="container">
  <!-- åœ°å›¾å®¹å™¨ -->
  <view class="map-container">
    <map
      id="routeMap"
      class="route-map"
      longitude="{{mapCenter.longitude}}"
      latitude="{{mapCenter.latitude}}"
      scale="{{mapScale}}"
      markers="{{markers}}"
      polyline="{{polylines}}"
      show-location="{{true}}"
      enable-3D="{{false}}"
      show-compass="{{false}}"
      enable-overlooking="{{false}}"
      enable-zoom="{{true}}"
      enable-scroll="{{true}}"
      enable-rotate="{{false}}"
      enable-satellite="{{false}}"
      enable-traffic="{{false}}"
      bindmarkertap="onMarkerTap"
      bindtap="onMapTap"
      bindregionchange="onRegionChange"
    ></map>
    
    <!-- åœ°å›¾æ§åˆ¶æŒ‰é’® -->
    <view class="map-controls">
      <view class="control-btn" bindtap="moveToLocation">
        <text class="control-icon">ğŸ“</text>
      </view>
    </view>
  </view>

  <!-- è·¯çº¿è§„åˆ’é¢æ¿ -->
  <view class="route-panel">
    <!-- èµ·ç‚¹ç»ˆç‚¹è¾“å…¥ -->
    <view class="input-section">
      <view class="input-item">
        <view class="input-label">èµ·ç‚¹</view>
        <view class="input-content" bindtap="selectStartPoint">
          <text class="input-text">{{startPoint.name || 'è¯·é€‰æ‹©èµ·ç‚¹'}}</text>
          <text class="input-icon">ğŸ“</text>
        </view>
      </view>
      
      <view class="input-item">
        <view class="input-label">ç»ˆç‚¹</view>
        <view class="input-content" bindtap="selectEndPoint">
          <text class="input-text">{{endPoint.name || 'è¯·é€‰æ‹©ç»ˆç‚¹'}}</text>
          <text class="input-icon">ğŸ¯</text>
        </view>
      </view>
      
      <!-- é€”å¾„ç‚¹ï¼ˆä»…é©¾è½¦æ¨¡å¼æ˜¾ç¤ºï¼‰ -->
      <view class="waypoints-section" wx:if="{{selectedTransport === 'driving'}}">
        <view class="section-title">é€”å¾„ç‚¹</view>
        <view class="waypoints-list">
          <view wx:for="{{waypoints}}" wx:key="index" class="waypoint-item">
            <view class="waypoint-info" bindtap="selectWaypoint" data-index="{{index}}">
              <text class="waypoint-text">{{item.name || 'è¯·é€‰æ‹©é€”å¾„ç‚¹'}}</text>
              <text class="waypoint-number">{{index + 1}}</text>
            </view>
            <view class="waypoint-remove" bindtap="removeWaypoint" data-index="{{index}}">
              <text>âœ•</text>
            </view>
          </view>
          
          <view class="add-waypoint" bindtap="addWaypoint">
            <text class="add-icon">+</text>
            <text class="add-text">æ·»åŠ é€”å¾„ç‚¹</text>
          </view>
        </view>
      </view>
    </view>

    <!-- äº¤é€šæ–¹å¼é€‰æ‹© -->
    <view class="transport-section">
      <view class="section-title">äº¤é€šæ–¹å¼</view>
      <view class="transport-options">
        <view 
          class="transport-item {{selectedTransport === 'driving' ? 'active' : ''}}"
          bindtap="selectTransport"
          data-type="driving"
        >
          <text class="transport-icon">ğŸš—</text>
          <text class="transport-name">é©¾è½¦</text>
        </view>
        <view 
          class="transport-item {{selectedTransport === 'walking' ? 'active' : ''}}"
          bindtap="selectTransport"
          data-type="walking"
        >
          <text class="transport-icon">ğŸš¶</text>
          <text class="transport-name">æ­¥è¡Œ</text>
        </view>
        <view 
          class="transport-item {{selectedTransport === 'bicycling' ? 'active' : ''}}"
          bindtap="selectTransport"
          data-type="bicycling"
        >
          <text class="transport-icon">ğŸš´</text>
          <text class="transport-name">éª‘è¡Œ</text>
        </view>
        <view 
          class="transport-item {{selectedTransport === 'transit' ? 'active' : ''}}"
          bindtap="selectTransport"
          data-type="transit"
        >
          <text class="transport-icon">ğŸšŒ</text>
          <text class="transport-name">å…¬äº¤</text>
        </view>
      </view>
    </view>

    <!-- è·¯çº¿ä¿¡æ¯ -->
    <view class="route-info" wx:if="{{routeInfo}}">
      <view class="info-row">
        <view class="info-item">
          <text class="info-label">è·ç¦»</text>
          <text class="info-value">{{routeInfo.distance}}</text>
        </view>
        <view class="info-item">
          <text class="info-label">æ—¶é—´</text>
          <text class="info-value">{{routeInfo.duration}}</text>
        </view>
      </view>
      <view class="info-row" wx:if="{{routeInfo.cost || routeInfo.tolls}}">
        <view class="info-item">
          <text class="info-label">è´¹ç”¨</text>
          <text class="info-value">{{routeInfo.cost || 'å…è´¹'}}</text>
        </view>
        <view class="info-item" wx:if="{{routeInfo.tolls > 0}}">
          <text class="info-label">è¿‡è·¯è´¹</text>
          <text class="info-value">Â¥{{routeInfo.tolls}}</text>
        </view>
      </view>
      <view class="info-row" wx:if="{{routeInfo.tollDistance > 0}}">
        <view class="info-item">
          <text class="info-label">æ”¶è´¹è·¯æ®µ</text>
          <text class="info-value">{{routeInfo.tollDistance}}ç±³</text>
        </view>
      </view>
    </view>

    <!-- æ“ä½œæŒ‰é’® -->
    <view class="action-section">
      <button class="action-btn secondary" bindtap="clearRoute">æ¸…é™¤è·¯çº¿</button>
      <button class="action-btn primary" bindtap="planRoute" disabled="{{!canPlanRoute}}">
        å¼€å§‹è§„åˆ’
      </button>
    </view>
  </view>

  <!-- åœ°ç‚¹æœç´¢å¼¹çª— -->
  <view class="search-modal" wx:if="{{showSearchModal}}">
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">
          {{searchType === 'start' ? 'é€‰æ‹©èµ·ç‚¹' : (searchType === 'end' ? 'é€‰æ‹©ç»ˆç‚¹' : 'é€‰æ‹©é€”å¾„ç‚¹' + (searchWaypointIndex !== null ? (searchWaypointIndex + 1) : ''))}}
        </text>
        <text class="close-btn" bindtap="closeSearchModal">âœ•</text>
      </view>
      
      <view class="search-input">
        <input 
          placeholder="æœç´¢åœ°ç‚¹" 
          value="{{searchKeyword}}"
          bindinput="onSearchInput"
          bindfocus="onSearchFocus"
          bindblur="onSearchBlur"
          bindconfirm="searchLocation"
        />
        <button class="search-btn" bindtap="searchLocation">æœç´¢</button>
      </view>
      
      <!-- å¿«é€Ÿé€‰æ‹© -->
      <view class="quick-actions">
        <button class="quick-btn" bindtap="useCurrentLocation">
          <text class="quick-icon">ğŸ“</text>
          <text>ä½¿ç”¨å½“å‰ä½ç½®</text>
        </button>
      </view>
      
      <!-- æœç´¢å»ºè®® -->
      <view class="search-suggestions" wx:if="{{showSuggestions && searchSuggestions.length > 0}}">
        <view 
          class="suggestion-item" 
          wx:for="{{searchSuggestions}}" 
          wx:key="id"
          bindtap="selectSuggestion"
          data-index="{{index}}"
        >
          <text class="suggestion-name">{{item.title}}</text>
          <text class="suggestion-address">{{item.address}}</text>
        </view>
      </view>
      
      <!-- æœç´¢ç»“æœ -->
      <view class="search-results" wx:if="{{!showSuggestions}}">
        <view 
          class="result-item" 
          wx:for="{{searchResults}}" 
          wx:key="id"
          bindtap="selectLocation"
          data-location="{{item}}"
        >
          <text class="result-name">{{item.title}}</text>
          <text class="result-address">{{item.address}}</text>
        </view>
        
        <view wx:if="{{searchResults.length === 0 && searchKeyword}}" class="no-results">
          <text>æœªæ‰¾åˆ°ç›¸å…³åœ°ç‚¹</text>
        </view>
      </view>
    </view>
  </view>
</view>