<!--pages/checkin/index/checkin.wxml-->
<view class="container">
  <!-- 页面标题 -->
  <view class="page-header">
    <text class="page-title">地图打卡</text>
    <text class="page-subtitle">记录您的旅行足迹</text>
  </view>

  <!-- 位置信息 -->
  <view class="location-section">
    <view class="location-header">
      <text class="section-title">📍 当前位置</text>
      <view class="location-actions">
        <button class="refresh-btn" bindtap="refreshLocation">
          <text class="refresh-icon">🔄</text>
        </button>
        <button class="custom-location-btn" bindtap="customLocationInput">
          <text class="custom-icon">📍 自定义</text>
        </button>
      </view>
    </view>
    
    <view class="location-info">
      <view class="location-item">
        <text class="location-label">经度：</text>
        <text class="location-value">{{longitude || '获取中...'}}</text>
      </view>
      <view class="location-item">
        <text class="location-label">纬度：</text>
        <text class="location-value">{{latitude || '获取中...'}}</text>
      </view>
      <view class="location-item">
        <text class="location-label">地址：</text>
        <text class="location-value">{{address || '正在解析地址...'}}</text>
      </view>
    </view>
  </view>

  <!-- 打卡内容 -->
  <view class="checkin-form">
    <view class="form-section">
      <view class="input-group" style="height: 339rpx; display: flex; box-sizing: border-box">
        <text class="input-label">打卡内容（可选）</text>
        <textarea style="height: 260rpx; display: block; box-sizing: border-box; left: 0rpx; top: 0rpx" class="input-field" placeholder="记录一下此刻的心情或感受..." bindinput="onContentInput" value="{{checkinContent}}" maxlength="500" />
        <view class="char-count">{{checkinContent.length}}/500</view>
      </view>

      <!-- 照片上传区域 -->
      <view class="input-group">
        <text class="input-label">上传照片</text>
        <view class="photo-upload">
          <view class="photo-list">
            <view class="photo-item" wx:for="{{checkinPhotos}}" wx:key="index">
              <image src="{{item}}" mode="aspectFill" class="uploaded-photo"></image>
              <view class="photo-delete" bindtap="deletePhoto" data-index="{{index}}">✕</view>
            </view>
            <view class="add-photo" bindtap="addPhoto" wx:if="{{checkinPhotos.length < 9}}" style="width: 200rpx; height: 200rpx; display: flex; box-sizing: border-box">
              <text class="add-icon">+</text>
              <text class="add-text">添加照片</text>
            </view>
          </view>
          <text class="photo-tip">最多可上传9张照片</text>
        </view>
      </view>

      <!-- 标签选择 -->
      <view class="input-group">
        <text class="input-label">添加标签</text>
        <view class="tags-container">
          <view class="tag-list">
            <view class="tag-item {{item.selected ? 'selected' : ''}}" 
                  wx:for="{{availableTags}}" wx:key="index"
                  bindtap="toggleTag" data-index="{{index}}">
              {{item.name}}
            </view>
          </view>
          <view class="add-tag" bindtap="showCustomTagInput">
            <text class="add-icon">+</text>
            <text class="add-text">自定义</text>
          </view>
        </view>
      </view>

      <!-- 关联相册 -->
      <view class="input-group">
        <text class="input-label">关联相册</text>
        <view class="album-selector" bindtap="selectAlbum">
          <text class="album-text">{{selectedAlbum ? selectedAlbum.name : '选择相册（可选）'}}</text>
          <text class="album-arrow">></text>
        </view>
      </view>

      <!-- 隐私设置 -->
      <view class="input-group">
        <text class="input-label">隐私设置</text>
        <view class="privacy-options">
          <view class="privacy-item">
            <radio checked="{{privacy === 'public'}}" bindtap="setPrivacy" data-privacy="public" />
            <text class="privacy-text">公开</text>
            <text class="privacy-desc">所有人可见</text>
          </view>
          <view class="privacy-item">
            <radio checked="{{privacy === 'private'}}" bindtap="setPrivacy" data-privacy="private" />
            <text class="privacy-text">私密</text>
            <text class="privacy-desc">仅自己可见</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 操作按钮 -->
  <view class="action-buttons">
    <button class="btn-secondary" bindtap="cancelCheckin">取消</button>
    <button class="btn-primary" bindtap="submitCheckin" disabled="{{!canSubmit}}">
      完成打卡
    </button>
  </view>

  <!-- 相册选择弹窗 -->
  <view class="modal-overlay" wx:if="{{showAlbumModal}}" bindtap="hideAlbumSelector">
    <view class="modal-content" >
      <view class="modal-header">
        <text class="modal-title">选择相册</text>
        <view class="close-btn" bindtap="hideAlbumSelector">✕</view>
      </view>
      
      <view class="modal-body">
        <view class="album-list">
          <view class="album-item {{item.id === selectedAlbumId ? 'selected' : ''}}" 
                wx:for="{{userAlbums}}" wx:key="id"
                bindtap="selectAlbumItem" data-album="{{item}}">
            <view class="album-info">
              <text class="album-name">{{item.name}}</text>
              <text class="album-desc">{{item.description || '暂无描述'}}</text>
            </view>
            <view class="album-status">
              <text class="photo-count">{{item.photoCount || 0}}张照片</text>
            </view>
          </view>
        </view>
      </view>
      
      <view class="modal-footer">
        <button class="btn-secondary" bindtap="hideAlbumSelector">取消</button>
        <button class="btn-primary" bindtap="confirmAlbum">确定</button>
      </view>
    </view>
  </view>

  <!-- 自定义标签输入弹窗 -->
  <view class="modal-overlay" wx:if="{{showTagInputModal}}" bindtap="hideCustomTagInput">
    <view class="modal-content" >
      <view class="modal-header">
        <text class="modal-title">添加自定义标签</text>
        <view class="close-btn" bindtap="hideCustomTagInput">✕</view>
      </view>
      
      <view class="modal-body">
        <view class="input-group">
          <text class="input-label">标签名称</text>
          <input class="input-field" placeholder="请输入标签名称" bindinput="onCustomTagInput" value="{{customTagName}}" maxlength="10" />
        </view>
      </view>
      
      <view class="modal-footer">
        <button class="btn-secondary" bindtap="hideCustomTagInput">取消</button>
        <button class="btn-primary" bindtap="addCustomTag">添加</button>
      </view>
    </view>
  </view>
</view>