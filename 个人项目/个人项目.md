# 微信小程序

## to do list

#### 已完成

- [x] 登录以及个人界面的所有功能
- [x] 相册的所有功能
- [x] 群组的所有功能
- [x] 小工具所有功能/没招了
- [ ] 打卡的所有功能
- [ ] 酒店比价的所有功能
- [ ] 路线规划的所有功能
- [ ] 统计的所有功能
- [ ] 云服务

## 版本信息

开发工具：微信开发者工具

开发语言：Javascript

小程序基础设施库版本：3.9.2

微信小程序api文档：[微信开放文档 / API](https://developers.weixin.qq.com/miniprogram/dev/api/)

微信小程序云数据库文档：[开发指引 / 基础能力 / 数据库 / 增删查改 (SDK) / 初始化](https://developers.weixin.qq.com/miniprogram/dev/wxcloudservice/wxcloud/guide/database/init.html)

B站api开发文档：[哔哩哔哩开放平台](https://open.bilibili.com/doc/4/7dddb3b5-afe9-7207-2316-9717a133b60e#h1-u4E09u65B9u8D44u6E90u63A5u53E3u5B9Eu73B0)

转发：[微信开放社区](https://developers.weixin.qq.com/community/develop/article/doc/0000405a194430a15aa29ec4d6b413)

## 功能需求

### 概述

首先所有功能可以分为以下三个板块：基本功能、旅游、娱乐

#### 基本功能

1. 登录和注册：微信授权登录和注册，方便后续和微信群进行联动的场景

2. 分享：

   - 旅游板块：

     - 功能性分享：可以将旅游小群/“共有”相册通过微信自带api和自己编写的功能（就是点击右上角三个点）分享给好友或者微信群，使得：点开分享可以直接加入"旅行小群"/直接将“”共有”相册加入自己的小程序中。

     - 图片使分享：点击地图页面的右上角的三个点，将被标注的地图作为图片分享到朋友圈

#### 旅游板块

1. 相册：此功能最基础的功能，并贯穿到下面的各个功能中去
   - 创建/删除相册：可以创建或者删除相册，可以添加多个相册，可以通过进入多个相册管理的模式对多个相册进行删除
   - 添加/删除图片：可以从手机相册/拍照/地图打卡/旅游小群等。
   - 属性：相册的属性有：个人、共有（旅游小群的成员都可以编辑和查看）

2. 地图：最主要的功能，首先可以通过官方公开的api连接到高德地图、google地图等（一个app即可），其中这个地图的图像分成两种：基础、特殊（命名不确定），可以通过右上角的选择键选择显示哪种，其中这两种分别能够进行下面的操作：

   - 基本的地图app功能：
     - 地图：显示地图图像，点击地图后能够获得当前地区的信息等；
     - 交通：用户导入地点（是一串地址，比如：地点A——地点B——地点C，这样的多个地点）后能够显示从地点A到地点B再到地点C的交通路线

   - 额外功能：
     - 打卡：能够点击地图相关地区（精确到某个国家某个省某个市的精度即可）进行打卡，打卡方式包括但不限于：文字+定位，图片+定位，文字+图片+定位，（图片可以选择拍照或者直接从相册中批量选择），并有小图标显示在地图上表示已经打过卡（双手放大地图的时候可以显示自己导入的打卡的照片；地图较小时可以只显示图片不显示打卡照片的缩略图）
     - 统计：能够设置获得 年旅游统计/使用小程序以来的所有统计，统计内容包括：打卡次数等（待补充，表现形式待补充）

   - 其他功能：
     - 酒店价钱比较：飞猪（[淘宝开放平台 - 文档中心](https://open.alitrip.com/docs/api_list.htm?spm=a219a.7629065.0.0.4f4d75fel6j90z&cid=20752)），携程（[携程API接口系列，酒店景点详情请求示例参考-阿里云开发者社区](https://developer.aliyun.com/article/1638626)）功能如下：用户输入信息、云函数获取价格、前端比价显示、跳转到最低价平台（微信小程序）

       - 飞猪：

         - 价格推送接口
           - 请求参数：

         | 名称                     | 类型   | 是否必须 | 示例值                                                       | 更多限制 | 描述                                                         |
         | :----------------------- | :----- | :------- | :----------------------------------------------------------- | :------- | :----------------------------------------------------------- |
         | rate_inventory_price_map | String | 必须     | [{"out_rid":"ABCDE_123","rateplan_code":"ABCDE_WHL01","vendor":"","lock_start_time":"","lock_end_time":"","data":{"use_room_inventory":false,"inventory_price":[{"date":"2013-11-18","quota":1,"price":1000,"status":1,"tax":10,"taxes":[{"taxId":0,"type":"Excluded","valueType":"percentage","amount":20},{"taxId":3,"type":"Mandatory","valueType":"percentage","amount":10}]},{"date":"2013-11-19","quota":1,"price":1000,"status":0,"tax":10,"taxes":[{"taxId":0,"type":"Excluded","valueType":"percentage","amount":20},{"taxId":3,"type":"Mandatory","valueType":"percentage","amount":10}]}]}},{"out_rid":"ABCDE_234","rateplan_code":"ABCDE_WHL01","vendor":"","data":{"use_room_inventory":false,"inventory_price":[{"date":"2013-11-18","quota":1,"price":1000,"status":1,"tax":10,"taxes":[{"taxId":0,"type":"Excluded","valueType":"percentage","amount":20},{"taxId":3,"type":"Mandatory","valueType":"percentage","amount":10}]},{"date":"2013-11-19","quota":1,"price":1000,"status":0,"tax":10,"taxes":[{"taxId":0,"type":"Excluded","valueType":"percentage","amount":20},{"taxId":3,"type":"Mandatory","valueType":"percentage","amount":10}]}]}}] |          | 批量修改价格和房价专有库存信息，json格式,可同时修改多套房型+价格计划的价格：A:use_room_inventory:是否使用房型共享库存，可选值 true false 1、true时：使用房型共享库存 2、false时：使用房价专有库存，此时要求房价专有库存必填。B:date 日期必须为 T-1 --- T+180 日内的日期（T为当天），不能重复。 C:price 价格 int类型 取值范围1-99999999 单位为分D:quota 房价专有库存 int 类型 取值范围 0-999（数量库存） 60000(状态库存关) 61000(状态库存开) E:status 价格开关，0为关，1为开。 F:taxes:税费明细，是一个数组，每个数组元素是一个包含税费信息的对象。包括：taxId：税费 ID，类型：int，必填：是，具体枚举：taxId=0=其他税（OTHER），taxId=3=住宿税（RENTAL_TAX）；type：税费类型，类型：string、必填：是，可选值：Mandatory：预付税费（包含在总价中），Excluded：到店税费（不包含在总价中）；valueType：费率类型，类型：string，必填：否，可选值：percentage：百分比、fixed：固定金额；amount：具体金额，类型：string，必填：否，单位：分/百分比。 注意：每个taxes数组里的含税金额相加要与tax的值一致，否则将会报错，当tax字段为空时则不会校验；当某税费不知道金额时则可不传tax字段，仅taxes字段里传对应信息即可；未知税费，请在taxId里选择其他税类，住宿税只能传1个，当传多个时飞猪则以第一个为主，若因传多个导致的问题，需由商家自行负责。 lock_start_time为锁库存开始时间，lock_end_time为锁库存结束时间，如果当前时间在这个时间范围内，那么不允许修改库存。 |
         | standard_xitem_infos     | String | 可选     | [ { "actionType": "BOUND", "outXCode": "123456", "subTypeCode": "70000_200", "name": "下午茶更新", "poi": "杭州西湖", "poiAddition": "杭州西湖addition", "subProducts": [ { "name": "早餐", "amount": 1,#如果子产品是早餐，份数建议与rate_quota_map这个价库字段的nop一致；若加赠早餐场景下，份数可自行控制 "price": 38 } ], "availableSubAmount": 3, "priceValue": { "price": 100, "sellingPrice": 100 }, "useRule": { "receptionTime": [ { "startTime": "00:00", "endTime": "01:00" }, { "startTime": "02:00", "endTime": "03:00" }, { "startTime": "03:00", "endTime": "04:00" } ], "adultAmount": 2, "childAmount": 1, "childHeight": "120", "childAge": "8", "bookingRule": 1, "bookingMinAmount": 2, "bookingUnit": 1, "contactNumber": "05316776678", "acquireType": 1, "effectiveType": 0, "additionalReminder": "补充提醒" }, "actionDimension": 1, "startDateTime": "2023-07-13 00:00:01", "endDateTime": "2024-07-13 00:00:01", "displayStartTime": "2023-07-13 00:00:01", "displayEndTime": "2024-07-13 00:00:01", "availableWeekDays": "1,2,3,4,5,6,7", "amount": 2, "childAmount": 2 } ] |          | 是一个JSONArray 字符串。actionType :操作类型,枚举 :BOUND:绑定,UNBOUND解绑; outXcode 外部Code直连场景下需求的x元素编码 ; subTypeCode x 元素子类目；name:x元素名称;productPic: 图片;{url图片url;mainPic是否为主图};poi:位置信息;subProducts:X元素子产品信息;{name:子产品名称,amount:数量,price:单价}priceValue价格信息;{retailPrice:门市价,sellingPricet:售卖价,currencyCode:销售币种默认CNY;valueCertificatePic价值凭证图片}；saleRule售卖规则;{receptionTime:接待时间段:支持多个,adultAmount建议成人数量,childAmount建议儿童数量,childHeight儿童身高限制;childAge儿童身高限制;bookingRule预约类型,枚举0无需预约/1需预约;bookingAmount最小预约单位(预约类型为1时有);bookingUnit预约单位,枚举天、小时(预约类型为1时有);contactPhone联系电话;acquireType获取方式,枚举1:酒店前台,2:其他;effectiveType是否入住期间有效,枚举,0入住期间,1入住首日;additionalReminder补充提醒};actionDimension使用维度 1:每间房维度 2:每间夜维度;startDateTime上架日期;displayStartTime权益可用开始时间;displayEndTime权益可用结束时间;amount打包数量;childAmount儿童打包数量；nop：如果推送x元素包含早餐，nop建议与早餐份数保持一致；若加赠早餐场景下，份数可自行控制；子产品份数：子产品中若包含早餐，份数建议与rate_quota_map中的nop一致；若加赠早餐场景下，份数可自行控制 |

         - 返回参数：

           | 名称          | 类型      | 示例值  | 描述                       |
           | :------------ | :-------- | :------ | :------------------------- |
           | gid_and_rpids | String [] | 111-123 | gid和rpid组合数组 gid_rpid |

3. 旅游小群（2-10人）

   最有交互性的功能，专为团体出行设计，通过在小程序中创建旅游小群并强调旅游小群和微信实际的群功能进行强联动，主要有以下功能：

   - 基础功能（类似微信群）
     - 创建：能够一个页面中创建微信小群并给出入群验证码（类似面对面建群或者说是房间号）或者给出房间二维码
     - 删除：可以删除微信小群，但是群相册中的照片不删除
     - 设置：可以点击直接点击当前群名称设置旅游小群的名称
     - 注意：不提供聊天功能
   - 交互功能（所有成员在同一个旅行小群中）：
     - 随机功能：可以创建轮盘，由设定轮盘的名字（所有人可以改），每个人可以填写自己想去的地点等等选项，生成轮盘，可由某个成员点击“开始”转动轮盘
     - 最低价-最高价：可以创建“事项”（名字没想好），由创建人设定事项的名字（所有人可以改），每个人可以填写自己心中的最低价和最低价（比如本次“事项”的名字是“酒店费用”，大家填写自己心中的最低价最高价），可以匿名也可以不匿名，当本小群的所有人都填写完成后，自动计算“最低价”中的最高、最低和平均值，以及“最高价”中的最高、最低和平均值
     - 共同相册：可以在相册中创建“共有”属性的相册
     - 注意以上功能的结果可以直接分享给微信群或者某个朋友。



## version 1：

### 页面设置：

### 当前的问题：

1. 酒店比价的api没有用上，是模拟的，还需要再制作
2. 缺少微信登录的部分（统一使用微信登陆，获得微信头像和昵称，以及微信好友和群的信息），缺少个人设置界面，这个界面应当包括（头像，昵称，退出登录，以及更新日志（开发者用的））
3. 旅游部分：功能“随机轮盘”（可以创建轮盘，由设定轮盘的名字（所有人可以改），每个人可以填写自己想去的地点等等选项，生成轮盘，可由某个成员点击“开始”转动轮盘），“价格投票”（可以创建“事项”（名字没想好），由创建人设定事项的名字（所有人可以改），每个人可以填写自己心中的最低价和最低价（比如本次“事项”的名字是“酒店费用”，大家填写自己心中的最低价最高价），可以匿名也可以不匿名，当本小群的所有人都填写完成后，自动计算“最低价”中的最高、最低和平均值，以及“最高价”中的最高、最低和平均值）没有做出来，且不需要“旅行小游戏”这个功能。且，这两个功能应当在“旅游群”页面中或者单开一个主题为“小工具”的页面。
4. “地图”部分：地图的“特殊”模式需要进行修改



## version2

### 页面设置：

1. 随机转盘的部分需要制作如下的页面：

   - 从上到下：
     - 导航栏
     - 显示未完成转盘输入的群组成员的头像（一行即可，如果有多余当前可显示的人数，则在改行的最后一个位置使用有省略号图标的按钮，点击该按钮后可以展开未输入的所有群组成员的头像以及在头像下方）
     - 中间一个圆形大转盘（带指针），一开始默认转盘为空，后面群成员输入内容后在转盘上显示该内容以及用颜色显示该内容的占比（类似一个饼状图）
     - 在下方有两个按钮，首先第一个按钮为输入内容，点击该按钮会跳转到类似于微信群成员接龙的界面，进行内容的填入或者修改，然后点击右上角的“确认”按钮完成修改；如果没有输入任何内容就退出则不添加任何内容。
     - 第二个按钮式“开始”按钮，点击该按钮则轮盘开始转动，适当时间后轮盘停止，指针指向的内容则为最终结果，最终结果可以在一开始以弹窗显示

   - 图形页面如下：

     ![](D:\25大三上夏季小学期\移动软件开发\个人项目\images\image-20250901185655478.png)

2. 心选价格

   - 具体页面类似随机转盘，但是将轮盘换成折线图，其中竖轴为价格，横轴为用户（如果是非匿名模式则显示用户昵称，如果是匿名模式则横轴上不显示）
   - 价格输入也类似接龙的形式，但是强制一行填两个空，一个空为最低价，一个空为最高价

### 问题：

1. 登录没有使用微信登陆，使用微信自带的api接口完成微信授权登录并读取好友
2. 小工具没有实际制作
3. 娱乐板块需要删掉
4. 酒店比较没有做全，需要参考飞猪和携程两个开发平台的api
5. 群组人数可以自定义
6. 创建群组同时直接加入群组
7. 说明可能需要用的数据库的表，以及每个表中所包含的字段



### version3

页面设置：

1. 首次进入小程序的用户默认先登录，使用微信授权登录，否则无法一直停留在首页；登录成功后跳转到index界面（登录使用云函数）
2. 修改“随即轮盘”和“心选价格”的配色，使得其与整体风格一致，并且要求转盘上不同选项的颜色也不一样。

问题：

1. 微信登陆失败，获取用户信息失败
2. 旅行群组的房间号（id）没有生成，需要自动生成不重复的房间号（id）
3. 删除“随即轮盘”和“心选价格”的历史功能

4. 将以下信息存入云数据库，并编写对应的云函数，并告知生成这些信息的表格的名字以及字段名字

```
### 1. 用户表 (users)

- id: 用户ID，主键
- openid: 微信OpenID
- unionid: 微信UnionID  
- nick_name: 用户昵称
- avatar_url: 头像URL
- gender: 性别
- phone: 手机号
- status: 状态
- created_at: 创建时间

### 2. 群组表 (groups)

- id: 群组ID，主键
- name: 群组名称
- description: 群组描述
- creator_id: 创建者ID
- type: 群组类型
- max_members: 最大成员数
- member_count: 当前成员数
- verification_type: 验证方式
- invite_code: 邀请码
- status: 状态

### 3. 群组成员表 (group_members)

- id: 记录ID，主键
- group_id: 群组ID
- user_id: 用户ID
- role: 角色
- join_time: 加入时间

### 4. 相册表 (albums)

- id: 相册ID，主键
- group_id: 群组ID
- name: 相册名称
- creator_id: 创建者ID
- photo_count: 照片数量

### 5. 照片表 (photos)

- id: 照片ID，主键
- album_id: 相册ID
- uploader_id: 上传者ID
- file_url: 文件URL
- location: 拍摄地点
- created_at: 上传时间

### 6. 打卡点表 (checkin_points)

- id: 打卡点ID，主键
- group_id: 群组ID
- name: 打卡点名称
- latitude: 纬度
- longitude: 经度
- address: 详细地址

### 7. 打卡记录表 (checkin_records)

- id: 记录ID，主键
- point_id: 打卡点ID
- user_id: 用户ID
- latitude: 打卡纬度
- longitude: 打卡经度
- photo_url: 打卡照片
- checkin_time: 打卡时间
```



## version4

### 登录问题

1. 登录后，获取用户微信头像和昵称

### 相册问题

1. 相册无法通过删除键删除，也无法编辑
2. 相册的名称输入格子太小
3. 无法搜索相册（应当是点击搜索以后，页面只保留匹配的相册，如果删除搜索框中的所有内容就是取消搜索，显示当前所有相册）

？共有相册能否使用



### 群组问题

1. 删掉发现更多群组的功能，只要创建群组默认创建者加入群组
2. 点击加入，但实际没有加入群组
3. 修改群组信息的功能错误，这个逻辑变成创建群组了，应当是在该群组信息的基础上进行数据修改以及保存
4. 删掉最近活动，群组设置只保留：编辑群组信息、成员管理、解散群组



## version5

### 群组问题：

1. 群组detail页面的背景和字的颜色变成一个了

2. 不再设定公开群组和私密群组，不再设置需要审批这个选项
3. 群组detail界面的随机转盘以及价格投票的功能没有连接到wheel和price
4. 共同相册功能=创建相册+设置关联群组（尽量使用已有的相册后端功能）

5. 群组创建共享相册以后，后面再点击共同相册则直接进入album的detail界面
6. 把个人设置放在导航栏的最中间

#### 小工具问题：

1. 美化页面，使得样式和全局的样式风格统一
2. 修改轮盘的颜色（随机，且这个颜色一定不能是白色），且根据权重获得颜色的占比



### version6

在保证其他功能和内容不变的情况下，修改以下问题：

### 小工具问题

1. 无法显示字体
2. convas会直接浮在表面

3. 转盘不再显示随机颜色，而是直接按照网站上的实例（[100px.net | 基于 Js / TS / Vue / React / 微信小程序 / uni-app / Taro 的【大转盘 & 九宫格 & 老虎机】抽奖插件](https://100px.net/)）显示固定的颜色和字体，相邻的两个内容颜色不一样

### **登录问题**

1. 刚进入小程序，则进入个人登录界面，如果不登陆则不能导航到其他页面

### 打卡问题

1. 在map的特殊模式，长按之前打过的卡则显示是否删除该打卡的浮窗，来删除之前的打卡记录
2. 在其他功能不变的情况下，实现地图的路线规划（按照输入的地点的位置显示两两地点之间的路线），如果无法实现就删除掉demo文件下所有和路线规划有关的内容

### 群组问题

1. 删掉所有与历史活动功能有关的内容
